name: Build CyberRoad Installer

# ─────────────────────────────────────────────────────────────────────────
#  CARA KERJA:
#  1. Kamu upload binary (CyberRoad.zip) ke GitHub Release tag "bins"
#  2. Workflow ini download dari sana saat build
#  3. Compile dengan Inno Setup → hasilkan installer .exe
#  4. Upload installer sebagai Artifact (bisa download 30 hari)
#  5. Kalau push tag v* → otomatis buat Release dengan installer
# ─────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  workflow_dispatch:

env:
  BINS_TAG: bins        # Tag GitHub Release tempat binary disimpan
  APP_NAME: CyberRoad

jobs:
  build-installer:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Install Inno Setup 6 ───────────────────────────────────────
      - name: Install Inno Setup 6
        run: |
          $url = "https://files.jrsoftware.org/is/6/innosetup-6.3.3.exe"
          Invoke-WebRequest -Uri $url -OutFile "$env:TEMP\issetup.exe"
          Start-Process "$env:TEMP\issetup.exe" -Args "/VERYSILENT /SUPPRESSMSGBOXES" -Wait
          echo "C:\Program Files (x86)\Inno Setup 6" | `
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: powershell

      # ── 3. Download binary dari GitHub Release "bins" ─────────────────
      #
      #  PERSIAPAN SEKALI (lakukan manual sebelum pertama kali push):
      #  a) Zip folder: zip -r CyberRoad_bins.zip extracted/
      #  b) Buat release di GitHub dengan tag "bins"
      #  c) Upload CyberRoad_bins.zip ke release tersebut
      #
      - name: Download binaries from release
        run: |
          gh release download $env:BINS_TAG `
            --repo $env:GITHUB_REPOSITORY `
            --pattern "CyberRoad_bins.zip" `
            --output "CyberRoad_bins.zip"
          Expand-Archive -Path "CyberRoad_bins.zip" -DestinationPath "." -Force
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── 4. Verify file structure ──────────────────────────────────────
      - name: Verify files
        run: |
          if (!(Test-Path "extracted\app\CyberRoad.exe")) {
            Write-Error "CyberRoad.exe not found!"
            exit 1
          }
          Write-Host "✅ All files present"
          Get-ChildItem extracted\app\ | Select-Object Name, @{N='Size(MB)';E={[math]::Round($_.Length/1MB,1)}}
        shell: powershell

      # ── 5. Build installer ────────────────────────────────────────────
      - name: Build installer with Inno Setup
        run: iscc "CyberRoad_Setup.iss"
        shell: cmd

      # ── 6. Get installer info ─────────────────────────────────────────
      - name: Get build info
        id: info
        run: |
          $f = Get-Item "output\*.exe"
          echo "filename=$($f.Name)" >> $env:GITHUB_OUTPUT
          echo "size=$([math]::Round($f.Length/1MB,1)) MB" >> $env:GITHUB_OUTPUT
          Write-Host "Built: $($f.Name) ($([math]::Round($f.Length/1MB,1)) MB)"
        shell: powershell

      # ── 7. Upload artifact ────────────────────────────────────────────
      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-Installer
          path: output/*.exe
          retention-days: 30

      # ── 8. Create Release (hanya saat push tag v*) ────────────────────
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: output/*.exe
          name: ${{ env.APP_NAME }} ${{ github.ref_name }}
          body: |
            ## ${{ env.APP_NAME }} ${{ github.ref_name }}

            **File:** `${{ steps.info.outputs.filename }}`
            **Size:** ${{ steps.info.outputs.size }}

            ### Cara Install
            1. Download file `.exe` di bawah
            2. Jalankan sebagai Administrator
            3. Ikuti wizard instalasi

            ### Requirements
            - Windows 10/11 (64-bit)
            - WebView2 Runtime *(installer otomatis)*
            - USB ADB Driver *(installer otomatis)*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
